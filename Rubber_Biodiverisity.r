#Author: Zhuangfang Yi, contact:zfyi@mortonarb.org; or find me at:http://geoyi.org
#Creat R script for calculate biodiversity counts
#First the country code for 8 countries in Asia
setwd(".../Biodiversity")
list.files(".../Biodiversity")

getwd()

#loading dplyr package
library(stats)
library(dplyr)
library(survival)
library(Formula)
library(Hmisc)
library(lubridate) # dates
library(ggthemes) # visualization
library(ggplot2)
library(rpart) # rpart for imputation
require(RColorBrewer)
library(randomForest)

#Install a financial package from GitHub
library("devtools")
install_github("felixfan/FinCal")
library(FinCal)

#Read Biodiversity data that includes Mammals, reptiles and amphibians
Mammals <- read.table('Mammals.csv',header = TRUE, sep = ",", quote = "", row.names = NULL, stringsAsFactors = FALSE)
Amphibians <- read.table('Amphibians.csv',header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE)
Reptiles <- read.table('Reptiles.csv',header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE)
Birds <- read.table('Birds.csv', header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE) 
Birds <- Birds %>% select(FID, BirdCounts)

# Rubber data
Rubber <- read.table('Rubber.csv',header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE)

#Other socioEconomic datasets that include Market Accessibility, other risks and Rubber growing suitability 
MarketAcc50k <- read.table('Acc_50k_Counties.csv',header = TRUE, sep = ",")
Suitablility <- read.table('Suitability100_Counties.csv',header = TRUE, sep = ",")
MinWageYield <- read.table('MinimumWageAndYield.csv',header = TRUE, sep = ",")
RubberMiniCost <- read.table('Rubber costs and prices in Asia.csv',header = TRUE, sep = ",")
Costs <- read.table('Costs of rubber plantations.csv',header = TRUE, sep = ",")
MiniPBiodi <- read.table('BioRubberCounties_With NPV&MiniPrice.csv',header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE)


MergeAll <- function(x,y) {
  merge(x,y, by = "FID")
}

#run the defined merge function
Test1 <- MergeAll(Rubber, Mammals) 
Test2 <- MergeAll(Reptiles, Amphibians)
test3 <- MergeAll(MarketAcc50k, Suitablility)


BioRubberCounties <- MergeAll(Test1, Test2) 
BioRubberCounties <- MergeAll(BioRubberCounties, Birds)

#%>% select(FID,Rubber.in.Ha, Mammals.counts,Reptiles.counts,Amphibians)

BioRubberCounties<- mutate(BioRubberCounties, Biodiversity = rowSums(BioRubberCounties[7:10],na.rm=TRUE))

BioRubberCounties <- MergeAll(BioRubberCounties, test3)

#define a function of normalization between 0 to 1. 

Normalization <- function(x){
  (x - min(x))/(max(x)-min(x))
}

#Normalize biodiversity loss indicator
NorBioD <- Normalization(BioRubberCounties$Biodiversity)

#Normalize rubber cultivation area
NorRubber <- Normalization(BioRubberCounties$Rubber.in.Ha)

#Normalize the average suitability
NorSuitability <- 1- Normalization(BioRubberCounties$Avg_Suitability)

#Normalize the average accessibility to the market
NorAcc.50k <- Normalization(BioRubberCounties$Acc.Mean)

NorBioRubber <- BioRubberCounties %>% select(FID, ISO, NAME_0) %>% 
  mutate(NorBioD) %>% 
  mutate(NorRubber) %>%ã€€
  mutate(NorSuitability) %>%
  mutate(NorAcc.50k)

#write a classification function 
Group5 <- function(x){
  as.numeric(cut2(x, g=5))
}

# value classification 
NorBioRubber$BioClass <- Group5(NorBioRubber$NorBioD)
NorBioRubber$RubberClass <- Group5(NorBioRubber$NorRubber)
#NorBioRubber$SuitaClass <- Group5(NorBioRubber$NorSuitability)
NorBioRubber$ACC50kClass <- Group5(NorBioRubber$NorAcc.50k)
NorBioRubber$biodiversity <- BioRubberCounties$Biodiversity
NorBioRubber$Rubber <- BioRubberCounties$Rubber.in.Ha 
#I would filter out the counties without rubber, which means we only going keep the counties have planted rubber trees.
NorBioRubber$RubberNo <- ifelse(NorBioRubber$Rubber > 0, 1, 0)

#classify traditional and non tradition area
NorBioRubber$TradNon <- ifelse(NorBioRubber$NorSuitability > 0.56, 'Non-Traditional', 'Traditional')
#Export the dataset 'BioRubberCounties'
NorBioRubber$Threats.on.Biodiversity <- ifelse(NorBioRubber$ACC50kClass == 5, "5-Very high",
                                    ifelse(NorBioRubber$ACC50kClass == 4, "4-High",
                                           ifelse(NorBioRubber$ACC50kClass == 3, "3-Normal",
                                                  ifelse(NorBioRubber$ACC50kClass == 2, "2-Low", "1-Very low"))))

NorBioRubber$Market.Accessibility <- ifelse(NorBioRubber$BioClass == 5, "5-Very difficult",
                                    ifelse(NorBioRubber$BioClass == 4, "4-Difficult",
                                           ifelse(NorBioRubber$BioClass == 3, "3-Normal",
                                                  ifelse(NorBioRubber$BioClass == 2, "2-Easy", "1-Very Easy"))))

write.table(BioRubberCounties, file = "BioRubberCounties.csv", sep = ',')
write.table(NorBioRubber, file = "Normolized BioRubber for Classification5.csv", sep = ',')

#Group all the indicators by countries
BioGroupAsia <- NorBioRubber %>% 
  group_by(ISO,TradNon,Threats.on.Biodiversity) %>% 
  filter(RubberNo == 1) %>%
  summarise(NorBioD = n())

#introduce color brewer here: http://colorbrewer2.org/

# Plot
g <- ggplot(BioGroupAsia, aes(x = ISO, y = NorBioD, fill = Threats.on.Biodiversity)) +
  geom_bar(stat = 'identity', position = 'fill', colour = 'white') +
  facet_wrap(~TradNon) +
  coord_flip() +
  labs(y = 'Propotion of Biodiveristy loss', 
       x = 'Countries') +
  theme_few()
       #title = 'Biodiversity loss index through Asia') 
  
g + scale_fill_manual(values=c("#edf8e9", "#bae4b3", "#74c476","#31a354","#006d2c"))

#Group around the market accessibility
Acc50kGroupAsia <- NorBioRubber %>% 
  group_by(ISO,TradNon,Market.Accessibility) %>% 
  filter(RubberNo == 1) %>%
  summarise(NorAcc.50k = n())

# Plot
a <- ggplot(Acc50kGroupAsia, aes(x = ISO, y = NorAcc.50k, fill = Market.Accessibility)) +
  geom_bar(stat = 'identity', position = 'fill', colour = 'white') +
  facet_wrap(~TradNon) +
  coord_flip() +
  labs(y = 'Propotion of market accessiblity', 
       x = 'Countries') +
  theme_few()
       #title = 'The difficulty of Market Accessibility')
  
a + scale_fill_manual(values=c("#f6eff7", "#bdc9e1", "#67a9cf","#1c9099","#016c59"))
### some results for the manuscript

aggregate(BioRubberCounties$Rubber.in.Ha, by=list(BioRubberCounties$ISO), FUN=sum)

sum(BioRubberCounties$Rubber.in.Ha)


### Costs of rubber plantations
ISO <- c('CHN','IDN','KHM','LAO','MMR','MYS','THA','VNM')
Yield <- c(1256, 894, 1206, 754, 754, 890, 1640, 1768)
MiniWage <- c(12, 10, 5, 5, 5, 13, 11, 6)
DR.r <- c(0.08, 0.078, 0.15, 0.13, 0.14, 0.06, 0.09, 0.11)

df <- data.frame(ISO,Yield,MiniWage,DR.r)

#Merge df with the original BioRubberCounties to a new dataset BioRubberCounties

BioRubberCounties <- merge(BioRubberCounties,df,by="ISO")

NorBioRubber$RubberArea <- BioRubberCounties$Rubber.in.Ha

#Calculate the proportion of traditional and non-traditional rubber cultivation area for 8 countries
RArea.Cou.Tr <-NorBioRubber %>% select(ISO, RubberNo, TradNon, RubberArea) %>% 
  group_by(ISO, TradNon) %>%
  filter(RubberNo == 1) %>%
  summarise_each(funs(sum))

write.table(RArea.Cou.Tr, file = "Traditional&Non Tradition Porpotion for countries.csv", sep = "," )

#Plot Biodverisity and Costs
Biodi.MiniP <- MiniPBiodi %>% select(FID, ISO, Biodiversity, MiniPrice) %>%
  mutate(Normalization(Biodiversity)) %>%
  mutate(1-Normalization(MiniPrice))

names(Biodi.MiniP)[5] <- 'BiodiversityN'
names(Biodi.MiniP)[6] <- 'Costs'

Biodi.MiniP$Classes <- within(Biodi.MiniP, out <- ifelse(BiodiversityN > 0.5 & Costs > 0.5, "Group4", 
                                                         ifelse(BiodiversityN < 0.5 & Costs < 0.5, "Group 1",
                                                                ifelse(BiodiversityN < 0.5 & Costs > 0.5, "Group 3", "Group 2"))))                                                                                           

ggplot(data=Biodi.MiniP, aes(x= BiodiversityN, y=Costs)) +  # Initialize plot 
  geom_point(aes(color = Classes))  

