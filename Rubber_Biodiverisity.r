#Author: Zhuangfang Yi, contact:zfyi@mortonarb.org; or find me at:http://geoyi.org
#Creat R script for calculate biodiversity counts
#First the country code for 8 countries in Asia
setwd("C:/GIS/Biodiversity")
list.files("C:/GIS/Biodiversity")

getwd()

#Read Biodiversity data that includes Mammals, reptiles and amphibians
Mammals <- read.table('Mammals.csv',header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE)
Amphibians <- read.table('Amphibians.csv',header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE)
Reptiles <- read.table('Reptiles.csv',header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE)

# Rubber data
Rubber <- read.table('Rubber.csv',header = TRUE, sep = ",", quote = "",row.names = NULL, stringsAsFactors = FALSE)

#Other socioEconomic datasets that include Market Accessibility, other risks and Rubber growing suitability 
MarketAcc50k <- read.table('Acc_50k_Counties.csv',header = TRUE, sep = ",")
Suitablility <- read.table('Suitability100_Counties.csv',header = TRUE, sep = ",")
MinWageYield <- read.table('MinimumWageAndYield.csv',header = TRUE, sep = ",")
RubberMiniCost <- read.table('Rubber costs and prices in Asia.csv',header = TRUE, sep = ",")


str(Mammals)
summary(Mammals)
summary(Amphibians)
summary(Reptiles)
summary(Rubber)

#loading dplyr package
library(stats)
library(dplyr)
library(survival)
library(Formula)
library(Hmisc)
library(lubridate) # dates
library(ggthemes) # visualization
library(ggplot2)
library(rpart) # rpart for imputation

MergeAll <- function(x,y) {
  merge(x,y, by = "FID")
}

#run the defined merge function
Test1 <- MergeAll(Rubber, Mammals) 
Test2 <- MergeAll(Reptiles, Amphibians)
test3 <- MergeAll(MarketAcc50k, Suitablility)


BioRubberCounties <- MergeAll(Test1, Test2) 

#%>% select(FID,Rubber.in.Ha, Mammals.counts,Reptiles.counts,Amphibians)

BioRubberCounties<- mutate(BioRubberCounties, Biodiversity = rowSums(BioRubberCounties[7:9],na.rm=TRUE))

BioRubberCounties <- MergeAll(BioRubberCounties, test3)

#define a function of normalization between 0 to 1. 

Normalization <- function(x){
  (x - min(x))/(max(x)-min(x))
}

#Normalize biodiversity loss indicator
NorBioD <- Normalization(BioRubberCounties$Biodiversity)

#Normalize rubber cultivation area
NorRubber <- Normalization(BioRubberCounties$Rubber.in.Ha)

#Normalize the average suitability
NorSuitability <- 1- Normalization(BioRubberCounties$Avg_Suitability)

#Normalize the average accessibility to the market
NorAcc.50k <- Normalization(BioRubberCounties$Acc.Mean)

NorBioRubber <- BioRubberCounties %>% select(FID, ISO, NAME_0) %>% 
  mutate(NorBioD) %>% 
  mutate(NorRubber) %>%ã€€
  mutate(NorSuitability) %>%
  mutate(NorAcc.50k)

#write a classification function 
Group5 <- function(x){
  as.numeric(cut2(x, g=5))
}

# value classification 
NorBioRubber$BioClass <- Group5(NorBioRubber$NorBioD)
NorBioRubber$RubberClass <- Group5(NorBioRubber$NorRubber)
#NorBioRubber$SuitaClass <- Group5(NorBioRubber$NorSuitability)
NorBioRubber$ACC50kClass <- Group5(NorBioRubber$NorAcc.50k)
NorBioRubber$biodiversity <- BioRubberCounties$Biodiversity
NorBioRubber$Rubber <- BioRubberCounties$Rubber.in.Ha 
#I would filter out the counties without rubber, which means we only going keep the counties have planted rubber trees.
NorBioRubber$RubberNo <- ifelse(NorBioRubber$Rubber > 0, 1, 0)

#classify traditional and non tradition area
NorBioRubber$TradNon <- ifelse(NorBioRubber$NorSuitability > 0.8, 'Non-Traditional', 'Traditional')
#Export the dataset 'BioRubberCounties'

write.table(BioRubberCounties, file = "BioRubberCounties.csv", sep = ',')
write.table(NorBioRubber, file = "Normolized BioRubber for Classification", sep = ',')

#Group all the indicators by countries
BioGroupAsia <- NorBioRubber %>% 
  group_by(ISO,TradNon,BioClass) %>% 
  filter(RubberNo == 1) %>%
  summarise(NorBioD = n())

# Plot
ggplot(BioGroupAsia, aes(x = ISO, y = NorBioD, fill = BioClass)) +
  geom_bar(stat = 'identity', position = 'fill', colour = 'white') +
  facet_wrap(~TradNon) +
  coord_flip() +
  labs(y = 'Propotion of Biodiveristy loss', 
       x = 'Countries',
       title = 'Biodiversity loss index through Asia') +
  theme_few()

#Group around the market accessibility
Acc50kGroupAsia <- NorBioRubber %>% 
  group_by(ISO,TradNon,ACC50kClass) %>% 
  filter(RubberNo == 1) %>%
  summarise(NorAcc.50k = n())

# Plot
ggplot(Acc50kGroupAsia, aes(x = ISO, y = NorAcc.50k, fill = ACC50kClass)) +
  geom_bar(stat = 'identity', position = 'fill', colour = 'white') +
  facet_wrap(~TradNon) +
  coord_flip() +
  labs(y = 'Propotion of market accessiblity', 
       x = 'Countries',
       title = 'The difficulty of Market Accessibility') +
  theme_few()
